name: UI Tests

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  ui-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'adopt'

      - name: Cache gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Decode google-services.json
        run: echo "$GOOGLE_SERVICES_JSON_BASE64" | base64 -d > app/google-services.json
        env:
          GOOGLE_SERVICES_JSON_BASE64: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Build for debug with gradle
        run: ./gradlew assembleDebug assembleAndroidTest

      - name: Check Docker version
        run: |
          docker --version
          docker ps

      - name: Start Docker Android Container
        run: |
          # Pull the Android emulator image
          docker pull budtmo/docker-android:emulator_13.0_v2.16.2-p0

          # Run the container with environment variables for faster boot
          docker run -d --name android-container \
            -p 4723:4723 -p 6080:6080 -p 5554:5554 -p 5555:5555 \
            -e EMULATOR_ARGS="-no-snapshot-save -no-audio -no-boot-anim -no-window -gpu swiftshader_indirect -accel on" \
            --privileged \
            budtmo/docker-android:emulator_13.0_v2.16.2-p0

          # Wait for container to fully initialize
          echo "Waiting for Android container to initialize..."
          sleep 120  # Increased from 90 to 120 seconds

          # Check container status
          docker ps
          docker logs android-container --tail 50

      - name: Install Android tools
        run: |
          sudo apt-get update
          sudo apt-get install -y android-tools-adb
          adb version

      - name: Set up ADB and connect to device
        run: |
          adb start-server

          # Get container IP
          CONTAINER_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' android-container)
          echo "Container IP: $CONTAINER_IP"

          # Connect to the emulator
          adb connect $CONTAINER_IP:5555

          # Wait for device to be fully booted (increased time)
          echo "Waiting for device to fully boot..."
          adb wait-for-device
          sleep 30

          # Check boot completion
          while true; do
            boot_completed=$(adb shell getprop sys.boot_completed | tr -d '\r')
            if [ "$boot_completed" == "1" ]; then
              break
            fi
            echo "Waiting for boot to complete..."
            sleep 10
          done

          # Check connected devices
          adb devices -l

          # Disable animations
          adb shell settings put global window_animation_scale 0.0
          adb shell settings put global transition_animation_scale 0.0
          adb shell settings put global animator_duration_scale 0.0

      - name: Run UI Tests
        run: |
          # Verify device is online
          adb devices

          # Install app
          ./gradlew installDebug

          # Run tests
          ./gradlew connectedDebugAndroidTest

      - name: Cleanup Docker Container
        if: always()
        run: |
          adb kill-server
          docker stop android-container
          docker rm android-container

      - name: Upload UI test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compose_test_report
          path: |
            app/build/reports/androidTests/connected/**/*
            app/build/outputs/androidTest-results/connected/**/*
          if-no-files-found: warn
